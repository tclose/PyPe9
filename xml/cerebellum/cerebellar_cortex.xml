<?xml version="1.0" encoding="UTF-8"?>
<nineml>
    <!-- The base network from which to build the main network -->
    <network id="CerebellarGranularLayer">
        <freeParameters>
            <flags>
                <flag id="includeGap" default="False" />
                <flag id="GranuleToGolgi" default="True" />
            </flags>
            <scalars />
        </freeParameters>
        <simulationDefaults>
            <temperature value="23" />
        </simulationDefaults>
        <extensions>
            <engine id="Brep" cmd="brep" resource="brep_filename_goes_here.xml" output="build/brep" />
        </extensions>
        <!-- Populations -->
        <population id="Granules" cell="ncml/Granule_DeSouza10.xml">
            <structure type="Extension" engine="Brep" id="Granules" />
            <comment>
                - Uniformly distributed cell soma positions within granular layer (0-200 um)
                - ascending fibers heights are uniformly disributed in molecular layer (230-430 um).
                  This will probably have to be implemented in morphologies somehow.
                - Synapse models require different seeds to determine synaptic failures 
                  (possibly could be set by cell GID as a hack)
            </comment>
            <cellParameters>
                <distribution component="Lkg1" attr="e_rev" type="uniform" low="-19.8"
                    high="-13.2" units="nA" />
                <distribution attr="diam" type="uniform" low="9.4" high="14.16" units="um"
                    segmentGroup="soma" />
            </cellParameters>
            <initialConditions>
                <distribution attr="v" type="uniform" low="-84" high="-56" units="mV" />
            </initialConditions>
        </population>
        <population id="Golgis" cell="ncml/Golgi_Solinas08.xml">
            <comment>
                - Uniformly distributed cell soma positions within granular layer (0-200 um)
                - Synapse models require different seeds to determine synaptic failures
            </comment>
            <structure type="Extension" engine="Brep" id="Golgis" />
            <cellParameters>
                <distribution attr="diam" type="uniform" low="21.6" high="32.4" units="um"
                    segmentGroup="soma" />
                <distribution component="Lkg" attr="e_rev" type="uniform" low="-66"
                    high="-44" units="nA" />
            </cellParameters>
            <initialConditions>
                <distribution attr="v" type="uniform" low="-84" high="-56" units="mV" />
            </initialConditions>
        </population>
        <population id="MossyFibers" cell="SpikeSourceArray">
            <structure type="Extension" engine="Brep" id="MossyFibers" />
            <comment>
                Cell position layout of the mossy fibers is uniformly distributed in the granular 
                layer (0-200 um)
            </comment>
        </population>
        <population id="Purkinjes" cell="ncml/Purkinje_Khaliq03.xml">
            <structure type="External" engine="Brep" id="Purkinjes" />
        </population>
        <population id="Stellates" cell="Stellate">
            <structure type="Grid3D" x_offset="0 um" y_offset="0 um" z_offset="0 um"
                x_extent="1 um" y_extent="1 um" x_number="50" y_number="50" />
        </population>
        <population id="Baskets" cell="Basket">
            <structure type="Grid3D" x_offset="0 um" y_offset="0 um" z_offset="0 um"
                x_extent="1 um" y_extent="1 um" z_extent="1 um" x_number="50" y_number="50"
                z_number="50" />
        </population>
        <!-- Projections -->
        <projection id="Granule_Purkinje">
            <source id="Granule" />
            <destination id="Purkinje" synapse="Exp2Syn" />
            <pattern type="External" engine="Brep" id="Granule-Purkinje" />
        </projection>
        <projection id="MossyFibers_Granules_AMPA">
            <source id="MossyFibers" />
            <destination id="Granules" synapse="AMPA" segment="soma" />
            <connection pattern="DistanceBased" geometry="CircleMask" radius="19.44 um" /> <!-- number="39" -->
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="2.6 nS"
                exponent="-0.01" />
            <delay pattern="DistanceBased" geometry="LinearWith2DDistance" scalar="2 us/um" />
        </projection>
        <projection id="MossyFibers_Granules_NMDA">
            <source id="MossyFibers" />
            <destination id="Granules" synapse="NMDA" segment="soma" />
            <connection pattern="DistanceBased" geometry="CircleMask" radius="19.44 um" /> <!-- number="25" -->
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="0.2244 nS"
                exponent="-0.01" />
            <delay pattern="DistanceBased" geometry="LinearWith2DDistance" scalar="2 us/um" />
            <comment> 
                - circleMask will do with probability in the case without glomeruli
                - In the case with glomeruli a morphology-based approach is required with multiple 
                  glomeruli (randomly constructed morphology) and Gaussian fields to granule cell
                  soma). Can be flagged out. Their positions are randomly placed along z
                
            
                The mossy fiber branches before the cerebellum and in the granular layer and
                gives off the rosettes/glomeruli (estimates say that one mossy fiber gives off about
                150 rosettes, which may cross folia. The rosettes are at a distance of about 100um
                of each other. Each rosette talks to about 20+ granule cells, and about one GoC
                Axon. Distribution of Glomeruli: Preferably homogeneous. Euclidean distance between
                rosettes about 85um (can be used as the radius of a sphere). Each Glomerulus
                contacts about 21 gr cells. One Glomerulus is contacted by a Golgi cell axon. We do
                not have that yet.
            </comment>
        </projection>
        <projection id="MossyFibers_Golgis_AMPA">
            <comment>
              - same as MF->Granules but different params
            </comment>
            <source id="MossyFibers" />
            <destination id="Golgis" synapse="AMPA_MossyFiber" segment="soma" />
            <connection pattern="DistanceBased" geometry="CircleMask" radius="291 um"
                probability="0.3" /> <!-- number="21" -->
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="2.6 nS"
                exponent="-0.01" />
            <delay pattern="DistanceBased" geometry="LinearWith2DDistance" scalar="2 us/um" />
        </projection>
        <projection id="Granules_Golgis" flags="GranuleToGolgi">
            <source id="Granules" />
            <destination id="Golgis" synapse="AMPA_Granule" segment="soma" />
            <connection pattern="DistanceBased" geometry="RectangleMask" x_scale="2500.0"
                y_scale="102.6" probability="0.5" />
            <!-- <connection pattern="Extension" engine="Brep" id="Granule-Golgi" /> -->
            <delay pattern="DistanceBased" geometry="LinearWith2DDistance" scalar="2 us/um"
                offset="300 us" />
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="2.6 nS"
                exponent="-0.01" />
            <!-- <weight pattern="Constant" value="2.6 nS" /> -->
            <!-- NB: Delay is set by brep -->
            <comment> 
                - PF to GoC Box in y and z plane, with the z of the Granules taken from the PF bifurcation.
                  Slightly difficult this one. Might need a special connector that takes into account
                  dendrtic extent. Exponential in x
                  
                - Axon to GoC, check to see if axon is below Golgi cell, circle mask in x-y  
                
                Golgi cells read off the parallel fibers. Golgi cell dendrites are confined to
                zebrin stripes. Each Golgi is estimated to read from up to 4000 granule cells (cat).
                The dendritic tree size is 200 x 600 x 180μm in cats. A simple way to get this
                connectivity is to have an ellipsoid with the dendritic tree size. With the number
                of synapses as above.
            </comment>
        </projection>
        <projection id="Golgis_Granules">
            <source id="Golgis" />
            <destination id="Granules" synapse="GABA" segment="soma" />
            <connection pattern="DistanceBased" geometry="EllipseMask" x_scale="200 um"
                y_scale="58.35 um" /> <!-- x_scale="600 um" -->
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="1.4 nS"
                exponent="-0.01" />
            <delay pattern="DistanceBased" geometry="LinearWith2DDistance" scalar="2 us/um" />
            <comment> 
                - rectangle mask in x-y plane
            
                There are about 400 Golgi cells per granule cell in the mouse. The axon does
                not seem to be confined as the dendrite, but it is rather flat and oriented in the
                same direction. Every granule cell receives from about 10 Golgi cells. I am not sure
                about this number. Better way to estimate it is to measure the axonal length and
                multiply by the density of synapses per um of axon. Currently we position the Golgi
                cells with a uniform distribution. We calculate the number of Golgi cells by 1.
                estimating the number of granule cells via density 2. multiplying that number by 400
            </comment>
        </projection>
        <projection id="Golgis_Golgis_Gap" synapseFamily="Electrical" flags="includeGap">
            <source id="Golgis" segment="soma" />
            <destination id="Golgis" segment="soma" />
            <!-- The connection radius is set very large because in the model each golgi is connected 
                to each other golgi, but currently AllToAll cannot be used with distance-based weight -->
            <connection pattern="DistanceBased" geometry="CircleMask" radius="10000000 um" />
            <weight pattern="DistanceBased" geometry="ExponentialWith2DDistance" scalar="1.5 nS"
                exponent="-0.03" />
            <comment> These are the golgi gap junction projection connections.
            </comment>
        </projection>
        <projection id="Granules_Baskets">
            <source id="Granules" />
            <destination id="Basket" />
            <pattern type="DistanceBased" geometry="Ellipse" x="50 um" y="174 um" prob="" />
            <comment> In humans there are about 50:1 inhibitory interneurons to PC. Safe bet in the
                rat is half that number. These neurons are most likely confined to travel
                para-saggitally, perpendicular to the PFs. The best numbers for the connectivity
                between PFs and Gr are the ones that Shyam has, we have to ask him. The arbors would
                be best represented by very elongated ellipsoids of about 174+/- 60 um along the
                parasaggital, with a short axis of maybe 50 um. The number of postsynaptic sites
                (reading from PFs) we ask Shyam. The distribution of inhibitory interneuron's somata
                is likely to be homogeneous. There is a morphological gradient from stellate to
                basket cells, as they go closer to the PN layer. Basket cells are in the deeper
                layers, and connect to purkinje somas. In the hoc, we first put stellates in the top
                one third and baskets in the bottom two thirds of the molecular layer. I don't like
                it. My preference is to first distribute the I.I. regardless of their category.
            </comment>
        </projection>
        <projection id="Granules_Stellates">
            <source id="Granules" />
            <destination id="Stellates" />
            <pattern type="DistanceBased" geometry="Ellipsoid" x="50 um" y="174 um" z="100 um"
                number="50" />
            <comment> In humans there are about 50:1 inhibitory interneurons to PC. Safe bet in the
                rat is half that number. These neurons are most likely confined to travel
                para-saggitally, perpendicular to the PFs. The best numbers for the connectivity
                between PFs and Gr are the ones that Shyam has, we have to ask him. The arbors would
                be best represented by very elongated ellipsoids of about 174+/- 60 um along the
                parasaggital, with a short axis of maybe 50 um. The number of postsynaptic sites
                (reading from PFs) we ask Shyam. The distribution of inhibitory interneuron's somata
                is likely to be homogeneous. There is a morphological gradient from stellate to
                basket cells, as they go closer to the PN layer. Stellate cells are in the deeper
                layers, and connect to purkinje somas. In the hoc, we first put stellates in the top
                one third and baskets in the bottom two thirds of the molecular layer. I don't like
                it. My preference is to first distribute the I.I. regardless of their category.
            </comment>
        </projection>
        <projection id="Baskets_Purkinjes">
            <source id="Baskets" />
            <destination id="Purkinjes" />
            <pattern type="DistanceBased" geometry="Ellipse" x="50 um" y="345 um" number="50" />
            <comment> The PN should be divided between soma and dendrites. The I.I. close to
                dendrites connect dendrites, and the ones close to the soma, to the soma. The axon
                reach on average was 345 μm (sd um 149). Looong. May connect to many PNs in the
                parasaggital (up to 7 has been observed). Hence, the axon can also be approximated
                by an elongated ellipsoid, even longer than the dendrites. Number of sites from I.I.
                to PN we have to ask Shyam. PF to PNs We estimate the number of PNs as 1:800 to
                granule cells. Their distribution is very regular in the parasaggital. The distance
                between PN arbors is on the 30um. The number of postsynaptic sites is about 1e5 in
                the mouse. The size of the arbor in the mouse is roughly 180x180x30. We position the
                purkinjes presuming no arbors overlap in volume. To find whether a PF contacts a PN
                we look if the PF's yz coordinates fall within the yz of the PN arbor.
            </comment>
        </projection>
        <projection id="Stellates_Purkinjes">
            <source id="Stellates" />
            <destination id="Purkinjes" />
            <pattern type="DistanceBased" geometry="Ellipse" x="50 um" y="345 um" number="50" />
            <comment> The PN should be divided between soma and dendrites. The I.I. close to
                dendrites connect dendrites, and the ones close to the soma, to the soma. The axon
                reach on average was 345 μm (sd um 149). Looong. May connect to many PNs in the
                parasaggital (up to 7 has been observed). Hence, the axon can also be approximated
                by an elongated ellipsoid, even longer than the dendrites. Number of sites from I.I.
                to PN we have to ask Shyam. PF to PNs We estimate the number of PNs as 1:800 to
                granule cells. Their distribution is very regular in the parasaggital. The distance
                between PN arbors is on the 30um. The number of postsynaptic sites is about 1e5 in
                the mouse. The size of the arbor in the mouse is roughly 180x180x30. We position the
                purkinjes presuming no arbors overlap in volume. To find whether a PF contacts a PN
                we look if the PF's yz coordinates fall within the yz of the PN arbor.
            </comment>
        </projection>
    </network>
</nineml>